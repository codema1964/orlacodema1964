<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orla Interactiva - GeneraciÃ³n del 64</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="firebase-config.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-bg': '#f7f9fb',
                        'card-bg': '#ffffff',
                        'accent-dark': '#0f172a',
                        'accent-teal': '#14b8a6', 
                        'secondary-text': '#64748b',
                        'old-view': '#2563eb', 
                        'current-view': '#9333ea', 
                    },
                },
            },
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; color: #0f172a; }
        .card-container { transition: transform 0.3s ease, box-shadow 0.3s ease; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .card-container:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .photo-wrapper { position: relative; overflow: hidden; border-radius: 0.75rem; width: 100%; padding-top: 100%; border: 1px solid #e2e8f0; }
        .photo-wrapper img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: opacity 0.4s ease, transform 0.4s ease; }
        .photo-wrapper img.hidden-photo { opacity: 0; transform: scale(1.05); }
        .photo-wrapper:hover img.hidden-photo { opacity: 1; transform: scale(1); }
        .photo-wrapper:hover img.visible-photo { opacity: 0; transform: scale(0.95); }
        .modal { background-color: rgba(0, 0, 0, 0.75); z-index: 50; }
        .text-xs-mono { font-size: 0.75rem; font-family: monospace; word-break: break-all; }
    </style>
</head>
<body class="min-h-screen">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, addDoc, getDocs, doc, setLogLevel, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === GESTIÃ“N DE CONFIGURACIÃ“N SEGURA ===
        let firebaseConfig;
        let ADMIN_UID;
        let ADMIN_EMAIL;

        // Intentamos cargar la configuraciÃ³n del archivo externo
        if (typeof firebaseConfigParams !== 'undefined') {
            firebaseConfig = firebaseConfigParams;
            ADMIN_UID = ADMIN_UID_CONFIG;
            ADMIN_EMAIL = typeof ADMIN_EMAIL_CONTACT !== 'undefined' ? ADMIN_EMAIL_CONTACT : 'admin@orla64.com';
        } else {
            // FALLBACK: Si no existe el archivo (ej: desarrollo local rÃ¡pido sin config.js)
            // Â¡ADVERTENCIA! No subas esto a GitHub si rellenas las claves aquÃ­.
            console.warn("No se encontrÃ³ firebase-config.js. Usando configuraciÃ³n por defecto.");
            alert("Falta el archivo firebase-config.js. La app puede no funcionar.");
        }

        const appId = 'default-app-id'; 
        
        // === VARIABLES Y ESTADO ===
        let db, auth;
        let alumniData = [];
        let currentView = null; 
        let selectedPerson = null; 
        let currentUserId = null; 
        let isDataListenerActive = false; 

        const getCollectionPath = () => `/artifacts/${appId}/public/data/alumni`;
        
        function sortByApellidos(a, b) {
            const nameA = (a.apellidos || '').toUpperCase();
            const nameB = (b.apellidos || '').toUpperCase();
            return (nameA < nameB) ? -1 : (nameA > nameB) ? 1 : 0;
        }

        function updateStatus(message, isError = false) {
            const statusElement = document.getElementById('connection-status');
            if (statusElement) {
                statusElement.innerHTML = message;
                statusElement.className = `p-2 text-center rounded-lg font-semibold mt-2 ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            }
            console.log(`[STATUS] ${message}`);
        }
        
        function showSelectionModal() {
            document.getElementById('selection-modal').classList.remove('hidden');
            document.getElementById('app-main-content').classList.add('hidden');
            document.getElementById('selection-status').textContent = "Selecciona una opciÃ³n para ver la orla.";
        }

        function hideSelectionModal() {
            document.getElementById('selection-modal').classList.add('hidden');
            document.getElementById('app-main-content').classList.remove('hidden');
        }

        window.selectView = function(viewType) {
            currentView = viewType; 
            hideSelectionModal();
            setupDataListener(); 
        }

        async function initializeFirebase() {
            if (!firebaseConfig) return;
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await setPersistence(auth, browserLocalPersistence);
                updateStatus("Conectando...", false);
                await signInAnonymously(auth);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        // Solo mostramos el UID si es el admin, por limpieza
                        if(isCurrentUserAdmin()) {
                             document.getElementById('current-uid-display').innerHTML = `MODO ADMIN <span class="text-xs opacity-50">(${currentUserId})</span>`;
                        } else {
                             document.getElementById('current-uid-display').textContent = "Modo VisualizaciÃ³n";
                        }
                        
                        updateStatus(`Conectado`, false);
                        showSelectionModal(); 
                    } else {
                        updateStatus("ERROR: AutenticaciÃ³n fallida.", true);
                    }
                });

            } catch (error) {
                updateStatus(`ERROR CRÃTICO: ${error.message}`, true);
            }
        }
        
        function isCurrentUserAdmin() {
            return currentUserId === ADMIN_UID;
        }

        // Nota: Ya no usamos isCurrentUserOwner para permitir editar. 
        // Solo Admin edita.
        
        function setupDataListener() {
            if (isDataListenerActive) return; 
            const alumniCollectionRef = collection(db, getCollectionPath());
            const q = query(alumniCollectionRef);
            isDataListenerActive = true;

            onSnapshot(q, (snapshot) => {
                alumniData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort(sortByApellidos); 
                window.displayData = [...alumniData];
                renderOrla();
                if (alumniData.length > 0) updateStatus(`Orla cargada. ${alumniData.length} compaÃ±eros.`, false);
            }, (error) => {
                updateStatus("ERROR DE LECTURA.", true);
                isDataListenerActive = false;
            });
        }
        
        // --- GESTIÃ“N DE MODALES Y FORMULARIOS ---

        window.openDataEntryModal = function(mode, personId = null) {
            // SEGURIDAD: Bloqueo preventivo en UI
            if (mode === 'edit' && !isCurrentUserAdmin()) {
                alert("Solo el administrador puede editar fichas.");
                return;
            }

            const modal = document.getElementById('data-entry-modal');
            const form = document.getElementById('data-entry-form');
            const titleElement = document.getElementById('data-entry-title');
            const buttonElement = document.getElementById('data-entry-button');
            
            form.reset();
            document.getElementById('data-entry-status').textContent = '';
            document.getElementById('form-mode').value = mode;
            document.getElementById('form-doc-id').value = personId || '';

            if (mode === 'edit' && personId) {
                selectedPerson = alumniData.find(p => p.id === personId);
                if (!selectedPerson) return;
                
                titleElement.textContent = `Editar: ${selectedPerson.nombre}`;
                buttonElement.textContent = 'Guardar Cambios';

                // Rellenar datos
                form.nombre.value = selectedPerson.nombre || '';
                form.apellidos.value = selectedPerson.apellidos || '';
                form.fotoAntiguaUrl.value = selectedPerson.antiguo?.fotoUrl || '';
                form.anoEntrada.value = selectedPerson.antiguo?.anoEntrada || '';
                form.anoSalida.value = selectedPerson.antiguo?.anoSalida || '';
                form.cursoEntrada.value = selectedPerson.antiguo?.cursoEntrada || '';
                form.cursoSalida.value = selectedPerson.antiguo?.cursoSalida || '';
                form.fechaFotoAntigua.value = selectedPerson.antiguo?.fechaFoto || '';
                form.fotoActualUrl.value = selectedPerson.actual?.fotoUrl || '';
                form.profesion.value = selectedPerson.actual?.profesion || '';
                form.ciudad.value = selectedPerson.actual?.ciudad || '';
                form.email.value = selectedPerson.actual?.email || '';

                window.closeModal(); 
            } else { 
                titleElement.textContent = 'AÃ±adir Nuevo CompaÃ±ero';
                buttonElement.textContent = 'Guardar';
            }

            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        window.openAddModal = function() {
            // Permitimos aÃ±adir a cualquiera? O solo Admin? 
            // El prompt dice "restringir permisos de ediciÃ³n excepto admin".
            // Asumiremos que "AÃ±adir" tambiÃ©n es solo Admin, o todos pueden "Proponer".
            // Por seguridad, vamos a restringir AÃ±adir solo a Admin tambiÃ©n.
            if(!isCurrentUserAdmin()) {
                 document.getElementById('permission-message').textContent = "Solo el administrador puede crear nuevas fichas. Por favor, envÃ­a los datos por email.";
                 document.getElementById('permission-modal').classList.remove('hidden');
                 return;
            }
            openDataEntryModal('add');
        }

        window.closeDataEntryModal = function() {
            document.getElementById('data-entry-modal').classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }

        window.saveAlumnusData = async function(event) {
            event.preventDefault();
            const form = event.target;
            const statusElement = document.getElementById('data-entry-status');
            const mode = document.getElementById('form-mode').value;
            const docId = document.getElementById('form-doc-id').value;

            statusElement.textContent = 'Guardando...';
            
            const dataToSave = {
                nombre: form.nombre.value || 'Sin Nombre',
                apellidos: form.apellidos.value || 'Sin Apellidos',
                antiguo: {
                    fotoUrl: form.fotoAntiguaUrl.value || '',
                    anoEntrada: form.anoEntrada.value || '',
                    anoSalida: form.anoSalida.value || '',
                    cursoEntrada: form.cursoEntrada.value || '',
                    cursoSalida: form.cursoSalida.value || '',
                    fechaFoto: form.fechaFotoAntigua.value || '',
                },
                actual: {
                    fotoUrl: form.fotoActualUrl.value || '',
                    profesion: form.profesion.value || '',
                    ciudad: form.ciudad.value || '',
                    email: form.email.value || '',
                }
            };
            
            try {
                const colPath = getCollectionPath();
                if (mode === 'add') {
                    await addDoc(collection(db, colPath), { ...dataToSave, ownerUid: currentUserId });
                } else if (mode === 'edit' && docId) {
                    await updateDoc(doc(db, colPath, docId), dataToSave);
                }
                statusElement.textContent = 'Â¡Guardado!';
                statusElement.className = 'text-green-600 mt-4';
                setTimeout(() => closeDataEntryModal(), 1000);
            } catch (error) {
                statusElement.textContent = `ERROR: ${error.message}`;
                statusElement.className = 'text-red-600 mt-4';
            }
        }
        
        window.openDeleteConfirmModal = function(id) {
            selectedPerson = alumniData.find(p => p.id === id);
            if (!selectedPerson) return;
            if (!isCurrentUserAdmin()) return; // Seguridad extra
            
            document.getElementById('confirm-doc-id').value = id;
            document.getElementById('confirm-message-name').textContent = `${selectedPerson.nombre} ${selectedPerson.apellidos}`;
            window.closeModal(); 
            document.getElementById('confirm-delete-modal').classList.remove('hidden');
        }

        window.closeDeleteConfirmModal = function() {
            document.getElementById('confirm-delete-modal').classList.add('hidden');
        }

        window.deleteAlumnusData = async function() {
            const docId = document.getElementById('confirm-doc-id').value;
            try {
                await deleteDoc(doc(db, getCollectionPath(), docId));
                closeDeleteConfirmModal();
            } catch (error) {
                alert("Error al eliminar: " + error.message);
            }
        }

        // --- RENDERIZADO ---

        function getPlaceholderColor(name) {
            const hash = name.split('').reduce((acc, char) => char.charCodeAt(0) + acc, 0);
            return `hsl(${hash % 360}, 40%, 80%)`;
        }

        window.renderCard = function(person) {
            if (!currentView) return '';
            const visiblePhotoUrl = currentView === 'old' ? person.antiguo?.fotoUrl : person.actual?.fotoUrl;
            const hiddenPhotoUrl = currentView === 'old' ? person.actual?.fotoUrl : person.antiguo?.fotoUrl;
            const fullName = `${person.nombre} ${person.apellidos}`;
            const placeholderColor = getPlaceholderColor(fullName);

            return `
                <div class="card-container bg-card-bg p-4 rounded-xl flex flex-col items-center text-center">
                    <div class="photo-wrapper cursor-pointer mb-3" onclick="openModal('${person.id}')">
                        <img src="${visiblePhotoUrl || ''}" onerror="this.style.backgroundColor='${placeholderColor}'; this.src='https://placehold.co/150x150/${placeholderColor.substring(4, 11)}/0f172a?text=${currentView === 'old' ? 'A' : 'C'}'" class="visible-photo">
                        <img src="${hiddenPhotoUrl || ''}" onerror="this.style.backgroundColor='${placeholderColor}'; this.src='https://placehold.co/150x150/${placeholderColor.substring(4, 11)}/0f172a?text=${currentView === 'old' ? 'C' : 'A'}'" class="hidden-photo">
                    </div>
                    <h3 class="text-lg font-semibold text-accent-dark">${fullName}</h3>
                </div>
            `;
        }

        window.renderOrla = function() {
            const orlaContainer = document.getElementById('orla-container');
            if (!orlaContainer) return;
            orlaContainer.innerHTML = window.displayData.map(renderCard).join('');
            
            const toggleButton = document.getElementById('toggle-all-btn');
            const isOldView = currentView === 'old';
            toggleButton.textContent = isOldView ? 'Mostrar Orla Actual' : 'Mostrar Orla Antigua';
            toggleButton.className = `w-full md:w-auto py-3 px-6 rounded-xl text-white font-bold shadow-md transition duration-300 transform hover:scale-[1.02] ${isOldView ? 'bg-current-view hover:bg-current-view/90' : 'bg-old-view hover:bg-old-view/90'}`;
            document.getElementById('header-title').textContent = isOldView ? 'Orla CODEMA 1964 - Ã‰poca del Colegio' : 'Orla CODEMA 1964 - Presente';
        }

        window.toggleAllPhotos = function() {
            currentView = currentView === 'old' ? 'current' : 'old';
            renderOrla();
        }

        window.performSearch = function() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const filterType = document.getElementById('filter-select').value;
            window.displayData = alumniData.filter(person => {
                const fullName = `${person.nombre} ${person.apellidos}`.toLowerCase();
                const pastData = person.antiguo ? `${person.antiguo.anoEntrada} ${person.antiguo.anoSalida} ${person.antiguo.cursoEntrada}`.toLowerCase() : '';
                const currentData = person.actual ? `${person.actual.profesion} ${person.actual.ciudad}`.toLowerCase() : '';
                if (!query) return true; 
                if (filterType === 'all') return fullName.includes(query) || pastData.includes(query) || currentData.includes(query);
                if (filterType === 'name') return fullName.includes(query);
                return false;
            });
            renderOrla();
        }

        // --- MODAL DETALLE CON EMAIL ---

        window.openModal = function(id) {
            selectedPerson = alumniData.find(p => p.id === id);
            if (!selectedPerson) return;
            document.getElementById('modal-wrapper').classList.remove('hidden');
            document.body.classList.add('overflow-hidden'); 
            updateModalContent(currentView); 
        }

        window.closeModal = function() {
            document.getElementById('modal-wrapper').classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            selectedPerson = null;
        }

        window.toggleModalPhoto = function() {
            const newView = document.getElementById('modal-view-state').value === 'old' ? 'current' : 'old';
            updateModalContent(newView);
        }
        
        // NUEVA FUNCIÃ“N: Generar mailto
        window.sendCorrectionEmail = function() {
            if(!selectedPerson) return;
            const subject = encodeURIComponent(`CorrecciÃ³n datos Orla: ${selectedPerson.nombre} ${selectedPerson.apellidos}`);
            const body = encodeURIComponent(`Hola,\n\nQuisiera aportar/corregir los siguientes datos para la ficha de ${selectedPerson.nombre} ${selectedPerson.apellidos}:\n\n- Datos a corregir: \n\n(Escribe aquÃ­ los datos)\n\nUn saludo.`);
            window.location.href = `mailto:${ADMIN_EMAIL}?subject=${subject}&body=${body}`;
        }

        function updateModalContent(view) {
            if (!selectedPerson) return;
            const isOldView = view === 'old';
            document.getElementById('modal-view-state').value = view;

            // Textos e Imagen
            document.getElementById('modal-name').textContent = `${selectedPerson.nombre} ${selectedPerson.apellidos}`;
            
            const photoUrl = isOldView ? selectedPerson.antiguo?.fotoUrl : selectedPerson.actual?.fotoUrl;
            const photoElement = document.getElementById('modal-photo');
            const placeholderColor = getPlaceholderColor(selectedPerson.nombre);
            photoElement.src = photoUrl || '';
            photoElement.onerror = () => {
                photoElement.style.backgroundColor = placeholderColor;
                photoElement.src = `https://placehold.co/200x200/${placeholderColor.substring(4, 11)}/0f172a?text=${isOldView ? 'A' : 'C'}`;
            };

            // Rellenar datos
            const past = selectedPerson.antiguo || {};
            const current = selectedPerson.actual || {};
            document.getElementById('past-details').innerHTML = `
                <h4 class="text-xl font-bold mb-3 text-old-view">Ã‰poca en el Colegio</h4>
                <p><strong>AÃ±os:</strong> ${past.anoEntrada || '-'} - ${past.anoSalida || '-'}</p>
                <p><strong>Curso Entrada:</strong> ${past.cursoEntrada || '-'}</p>
                <p><strong>Curso Salida:</strong> ${past.cursoSalida || '-'}</p>
            `;
            document.getElementById('current-details').innerHTML = `
                <h4 class="text-xl font-bold mb-3 text-current-view">Actualidad</h4>
                <p><strong>ProfesiÃ³n:</strong> ${current.profesion || '-'}</p>
                <p><strong>Ciudad:</strong> ${current.ciudad || '-'}</p>
            `;

            // GESTIÃ“N DE BOTONES SEGÃšN PERMISOS
            const editBtn = document.getElementById('modal-edit-btn');
            const deleteBtn = document.getElementById('modal-delete-btn'); 
            const emailBtn = document.getElementById('modal-email-btn');

            // LÃ³gica: Si es Admin -> Editar/Borrar. Si NO es Admin -> BotÃ³n Email.
            if (isCurrentUserAdmin()) {
                editBtn.classList.remove('hidden');
                deleteBtn.classList.remove('hidden');
                emailBtn.classList.add('hidden');
                
                editBtn.onclick = () => openDataEntryModal('edit', selectedPerson.id);
                deleteBtn.onclick = () => openDeleteConfirmModal(selectedPerson.id);
            } else {
                editBtn.classList.add('hidden');
                deleteBtn.classList.add('hidden');
                emailBtn.classList.remove('hidden'); // MOSTRAR BOTÃ“N EMAIL
            }
            
            const toggleBtn = document.getElementById('modal-toggle-btn');
            toggleBtn.textContent = isOldView ? 'Ver Foto Actual' : 'Ver Foto Antigua';
            toggleBtn.className = `py-2 px-4 rounded-full text-white font-semibold transition duration-300 w-full mt-2 shadow-md ${isOldView ? 'bg-current-view hover:bg-current-view/90' : 'bg-old-view hover:bg-old-view/90'}`;
        }

        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>

    <div id="selection-modal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-card-bg rounded-xl shadow-2xl w-full max-w-2xl p-8 text-center">
            <h2 class="text-4xl font-extrabold text-accent-dark mb-4">Orla GeneraciÃ³n del 64</h2>
            <p class="text-xl text-secondary-text mb-10">Selecciona la Ã©poca a visualizar:</p>
            <div class="flex flex-col md:flex-row gap-6 justify-center">
                <button onclick="selectView('old')" class="flex-1 py-4 px-6 rounded-xl text-white font-bold text-lg bg-old-view hover:bg-old-view/90 shadow-lg transition transform hover:scale-105">ðŸŽ“ Etapa Colegio</button>
                <button onclick="selectView('current')" class="flex-1 py-4 px-6 rounded-xl text-white font-bold text-lg bg-current-view hover:bg-current-view/90 shadow-lg transition transform hover:scale-105">ðŸ’¼ Actualidad</button>
            </div>
            <p id="selection-status" class="text-sm text-secondary-text mt-6">Cargando...</p>
        </div>
    </div>

    <div id="modal-wrapper" class="modal fixed inset-0 flex items-center justify-center p-4 hidden" onclick="if(event.target.id === 'modal-wrapper') closeModal()">
        <div class="bg-card-bg rounded-xl shadow-2xl w-full max-w-4xl p-8 relative">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-secondary-text hover:text-accent-dark"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <h2 id="modal-name" class="text-3xl font-extrabold text-center mb-6 text-accent-dark"></h2>
            
            <div class="flex flex-col md:flex-row gap-8">
                <div class="md:w-1/3 flex flex-col items-center">
                    <div class="w-48 h-48 mb-4 bg-primary-bg rounded-full overflow-hidden shadow-inner border-4 border-white">
                        <img id="modal-photo" src="" class="w-full h-full object-cover">
                    </div>
                    <input type="hidden" id="modal-view-state" value="old">
                    <button id="modal-toggle-btn" onclick="toggleModalPhoto()"></button>
                    
                    <div class="flex flex-col gap-3 w-full max-w-[200px] mt-6 pt-4 border-t border-gray-100">
                        <button id="modal-email-btn" onclick="sendCorrectionEmail()" class="hidden flex items-center justify-center gap-2 py-2 px-4 rounded-full bg-amber-500 text-white font-semibold hover:bg-amber-600 transition shadow-md">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            Enviar Datos
                        </button>

                        <button id="modal-edit-btn" class="hidden py-2 px-4 rounded-full bg-accent-teal text-white font-semibold hover:bg-teal-600 transition shadow-md">Editar Datos</button>
                        <button id="modal-delete-btn" class="hidden py-2 px-4 rounded-full bg-red-600 text-white font-semibold hover:bg-red-700 transition shadow-md">Eliminar Ficha</button>
                    </div>
                </div>
                <div class="md:w-2/3 grid grid-cols-1 md:grid-cols-2 gap-6 pl-0 md:pl-8 md:border-l border-gray-100">
                    <div id="past-details" class="text-secondary-text space-y-2"></div>
                    <div id="current-details" class="text-secondary-text space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="app-main-content" class="hidden">
        <header class="bg-card-bg shadow-lg sticky top-0 z-10">
            <div class="max-w-7xl mx-auto py-4 px-4 flex flex-col md:flex-row justify-between items-center gap-4">
                <button onclick="openAddModal()" class="py-2 px-4 rounded-full bg-accent-teal text-white font-semibold shadow-md hover:bg-teal-600 transition">AÃ±adir CompaÃ±ero</button>
                <h1 id="header-title" class="text-2xl md:text-3xl font-extrabold text-accent-dark"></h1>
                <div id="current-uid-display" class="text-xs text-secondary-text font-mono"></div>
            </div>
            <div id="connection-status" class="text-center text-xs py-1 bg-gray-50"></div>
        </header>

        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="bg-card-bg p-4 rounded-xl shadow-md mb-8 flex flex-col md:flex-row gap-4 justify-between">
                <div class="flex w-full md:w-2/3 gap-2">
                    <input type="text" id="search-input" onkeyup="performSearch()" placeholder="Buscar..." class="flex-grow p-2 border rounded-lg focus:ring-2 focus:ring-accent-teal">
                    <select id="filter-select" onchange="performSearch()" class="p-2 border rounded-lg">
                        <option value="all">Todo</option>
                        <option value="name">Nombre</option>
                    </select>
                </div>
                <button id="toggle-all-btn" onclick="toggleAllPhotos()"></button>
            </div>
            
            <div id="orla-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6"></div>
        </div>
    </div>

    <div id="data-entry-modal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-card-bg rounded-xl shadow-2xl w-full max-w-2xl p-6 max-h-[90vh] overflow-y-auto relative">
            <button onclick="closeDataEntryModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">âœ•</button>
            <h2 id="data-entry-title" class="text-2xl font-bold text-center mb-4"></h2>
            <form id="data-entry-form" onsubmit="saveAlumnusData(event)" class="space-y-4">
                <input type="hidden" id="form-mode"><input type="hidden" id="form-doc-id">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="nombre" placeholder="Nombre" class="p-2 border rounded" required>
                    <input type="text" id="apellidos" placeholder="Apellidos" class="p-2 border rounded" required>
                </div>
                <div class="p-3 bg-blue-50 rounded border border-blue-100">
                    <h3 class="font-bold text-blue-800 text-sm mb-2">Colegio</h3>
                    <input type="url" id="fotoAntiguaUrl" placeholder="URL Foto Antigua" class="w-full p-2 border rounded mb-2 text-sm">
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <input type="number" id="anoEntrada" placeholder="AÃ±o Entrada" class="p-2 border rounded">
                        <input type="number" id="anoSalida" placeholder="AÃ±o Salida" class="p-2 border rounded">
                        <input type="text" id="cursoEntrada" placeholder="Curso Entrada" class="p-2 border rounded">
                        <input type="text" id="cursoSalida" placeholder="Curso Salida" class="p-2 border rounded">
                        <input type="text" id="fechaFotoAntigua" placeholder="Fecha Foto" class="p-2 border rounded">
                    </div>
                </div>
                <div class="p-3 bg-purple-50 rounded border border-purple-100">
                    <h3 class="font-bold text-purple-800 text-sm mb-2">Actualidad</h3>
                    <input type="url" id="fotoActualUrl" placeholder="URL Foto Actual" class="w-full p-2 border rounded mb-2 text-sm">
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <input type="text" id="profesion" placeholder="ProfesiÃ³n" class="p-2 border rounded">
                        <input type="text" id="ciudad" placeholder="Ciudad" class="p-2 border rounded">
                        <input type="email" id="email" placeholder="Email" class="p-2 border rounded w-full col-span-2">
                    </div>
                </div>
                <button type="submit" id="data-entry-button" class="w-full py-3 bg-accent-teal text-white font-bold rounded-lg hover:bg-teal-600"></button>
                <div id="data-entry-status" class="text-center font-bold text-sm"></div>
            </form>
        </div>
    </div>

    <div id="confirm-delete-modal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl p-6 max-w-sm text-center">
            <h3 class="text-xl font-bold text-red-600 mb-2">Â¿Eliminar ficha?</h3>
            <p class="text-sm text-gray-600 mb-4">Vas a eliminar a <span id="confirm-message-name" class="font-bold"></span>. No se puede deshacer.</p>
            <input type="hidden" id="confirm-doc-id">
            <div class="flex justify-center gap-3">
                <button onclick="closeDeleteConfirmModal()" class="px-4 py-2 border rounded hover:bg-gray-50">Cancelar</button>
                <button onclick="deleteAlumnusData()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Eliminar</button>
            </div>
        </div>
    </div>

    <div id="permission-modal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden z-50" onclick="this.classList.add('hidden')">
        <div class="bg-white rounded-xl p-6 max-w-sm text-center shadow-xl border-t-4 border-amber-500">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Acceso Restringido</h3>
            <p id="permission-message" class="text-gray-600">Solo el administrador puede realizar esta acciÃ³n.</p>
            <button class="mt-4 text-amber-600 font-bold text-sm hover:underline">Cerrar</button>
        </div>
    </div>

</body>
</html>